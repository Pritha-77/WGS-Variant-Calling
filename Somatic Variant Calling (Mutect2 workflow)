# This script is for demonstration purposes only

# Set directory path
ref="/mnt/c/GATK/index_files/hg38.fa"
known_sites="/mnt/c/GATK/index_files/Homo_sapiens_assembly38.dbsnp138.vcf"
aligned_reads="/mnt/c/GATK/aligned_reads"
reads="/mnt/c/GATK/reads"
results="/mnt/c/GATK/results"
data="/mnt/c/GATK/data"
gatk_path=/mnt/c/GATK/gatk
project_dir=/mnt/c/GATK/somatic_mutect2
mutect2_supporting_files="/mnt/c/GATK/index_files/mutect2_supporting_files"

############## Prep files (TO BE GENERATED ONLY ONCE) ###############

# download reference files
wget -P ~/Desktop/demo/supporting_files/hg38/ https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.fa.gz
gunzip ~/Desktop/demo/supporting_files/hg38/hg38.fa.gz

# index ref - .fai file before running haplotype caller
samtools faidx ~/Desktop/demo/supporting_files/hg38/hg38.fa

# ref dict - .dict file before running haplotype caller
gatk CreateSequenceDictionary R=~/Desktop/demo/supporting_files/hg38/hg38.fa O=~/Desktop/demo/supporting_files/hg38/hg38.dict

# download known sites files for BQSR from GATK resource bundle
wget -P ~/Desktop/demo/supporting_files/hg38/ https://storage.googleapis.com/genomics-public-data/resources/broad/hg38/v0/Homo_sapiens_assembly38.dbsnp138.vcf
wget -P ~/Desktop/demo/supporting_files/hg38/ https://storage.googleapis.com/genomics-public-data/resources/broad/hg38/v0/Homo_sapiens_assembly38.dbsnp138.vcf.idx

######### Mutect2 files (TO BE DOWNLOADED ONLY ONCE) #####################

#mutect2_supporting_files (Folder)
# gnomAD
wget https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/somatic-hg38/af-only-gnomad.hg38.vcf.gz 
wget https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/somatic-hg38/af-only-gnomad.hg38.vcf.gz.tbi 

# PoN
wget https://storage.googleapis.com/gatk-best-practices/somatic-hg38/1000g_pon.hg38.vcf.gz wget https://storage.googleapis.com/gatk-best-practices/somatic-hg38/1000g_pon.hg38.vcf.gz.tbi 

# to create your own panel of normals: 
https://gatk.broadinstitute.org/hc/en-us/articles/360037058172-CreateSomaticPanelOfNormals-BETA 

# intervals list
wget https://storage.googleapis.com/gcp-public-data--broad references/hg38/v0/exome_calling_regions.v1.1.interval_list 



# -----------------------
# Step 0: Download tumor & normal reads
# -----------------------
# Normal (N-D, duodenal tissue) and Tumor (T, PDAC cell line)

# N-D (Normal Duodenal tissue)
wget https://ftp-trace.ncbi.nlm.nih.gov/ReferenceSamples/giab/data_somatic/HG008/Liss_lab/NYGC_Illumina-WGS_20231023/HG008-N-D_CGGACAAC-AATCCGGA_H3LLJDSXC_L001_001.R1.fastq.gz ../reads/
wget https://ftp-trace.ncbi.nlm.nih.gov/ReferenceSamples/giab/data_somatic/HG008/Liss_lab/NYGC_Illumina-WGS_20231023/HG008-N-D_CGGACAAC-AATCCGGA_H3LLJDSXC_L001_001.R2.fastq.gz ../reads/

# T (Pancreatic Ductal Adenocarcinoma Cell Line (PDAC))
wget https://ftp-trace.ncbi.nlm.nih.gov/ReferenceSamples/giab/data_somatic/HG008/Liss_lab/NYGC_Illumina-WGS_20231023/HG008-T_TTCCTGTT-AAGATACT_HJVY2DSX7_L001_001.R1.fastq.gz ../reads/
wget https://ftp-trace.ncbi.nlm.nih.gov/ReferenceSamples/giab/data_somatic/HG008/Liss_lab/NYGC_Illumina-WGS_20231023/HG008-T_TTCCTGTT-AAGATACT_HJVY2DSX7_L001_001.R2.fastq.gz ../reads/

# -----------------------
# Step 1: Subset reads (for demo only)
# -----------------------

# Extract 1 million reads for quick testing
cd ../reads/
seqtk sample -s100 HG008-N-D_CGGACAAC-AATCCGGA_H3LLJDSXC_L001_001.R1.fastq.gz 1000000 > HG008-N-D_CGGACAAC-AATCCGGA_subset_H3LLJDSXC_L001_001.R1.fastq
seqtk sample -s100 HG008-N-D_CGGACAAC-AATCCGGA_H3LLJDSXC_L001_001.R2.fastq.gz 1000000 > HG008-N-D_CGGACAAC-AATCCGGA_subset_H3LLJDSXC_L001_001.R2.fastq
seqtk sample -s100 HG008-T_TTCCTGTT-AAGATACT_HJVY2DSX7_L001_001.R1.fastq.gz 1000000 > HG008-T_TTCCTGTT-AAGATACT_subset_HJVY2DSX7_L001_001.R1.fastq
seqtk sample -s100 HG008-T_TTCCTGTT-AAGATACT_HJVY2DSX7_L001_001.R2.fastq.gz 1000000 > HG008-T_TTCCTGTT-AAGATACT_subset_HJVY2DSX7_L001_001.R2.fastq

# -------------------
# STEP 2: QC - Run fastqc 
# -------------------
fastqc ${reads}/HG008-N-D_CGGACAAC-AATCCGGA_subset_H3LLJDSXC_L001_001.R1.fastq.gz -o ${reads}/
fastqc ${reads}/HG008-N-D_CGGACAAC-AATCCGGA_subset_H3LLJDSXC_L001_001.R2.fastq.gz -o ${reads}/

# --------------------------------------
# STEP 3: Map to reference using BWA-MEM
# --------------------------------------

# BWA index reference 
bwa index ${ref}

# BWA alignment
bwa mem -t 4 -R "@RG\tID:HG008-N-D\tPL:ILLUMINA\tSM:HG008-N-D" ${ref} ${reads}/HG008-N-D_CGGACAAC-AATCCGGA_subset_H3LLJDSXC_L001_001.R1.fastq.gz ${reads}/HG008-N-D_CGGACAAC-AATCCGGA_subset_H3LLJDSXC_L001_001.R2.fastq.gz > ${aligned_reads}/HG008-N-D.paired.sam
bwa mem -t 4 -R "@RG\tID:HG008-T\tPL:ILLUMINA\tSM:HG008-T" ${ref} ${reads}/HG008-T_TTCCTGTT-AAGATACT_subset_HJVY2DSX7_L001_001.R1.fastq.gz ${reads}/HG008-T_TTCCTGTT-AAGATACT_subset_HJVY2DSX7_L001_001.R2.fastq.gz > ${aligned_reads}/HG008-T.paired.sam

# -----------------------------------------
# STEP 4: Mark Duplicates and Sort - GATK4
# -----------------------------------------
gatk MarkDuplicatesSpark -I ${aligned_reads}/HG008-T.paired.sam -O ${aligned_reads}/HG008-T_sorted_dedup_reads.bam
gatk MarkDuplicatesSpark -I ${aligned_reads}/HG008-N-D.paired.sam -O ${aligned_reads}/HG008-N-D_sorted_dedup_reads.bam

# ----------------------------------
# STEP 5: Base quality recalibration
# ----------------------------------
         
#Build the model
gatk BaseRecalibrator -I ${aligned_reads}/HG008-N-D_sorted_dedup_reads.bam -R ${ref} --known-sites ${known_sites} -O ${aligned_reads}/HG008-N-D_recal_data.table
gatk BaseRecalibrator -I ${aligned_reads}/HG008-T_sorted_dedup_reads.bam -R ${ref} --known-sites ${known_sites} -O ${aligned_reads}/HG008-T_recal_data.table
         
#Apply the model to adjust the base quality scores
gatk ApplyBQSR -I ${aligned_reads}/HG008-N-D_sorted_dedup_reads.bam -R ${ref} --bqsr-recal-file ${aligned_reads}/HG008-N-D_recal_data.table -O ${aligned_reads}/HG008-N-D_sorted_dedup_bqsr_reads.bam 
gatk ApplyBQSR -I ${aligned_reads}/HG008-T_sorted_dedup_reads.bam -R ${ref} --bqsr-recal-file ${aligned_reads}/HG008-T_recal_data.table -O ${aligned_reads}/HG008-T_sorted_dedup_bqsr_reads.bam 


# -----------------------------------------------
# STEP 6: Collect Alignment & Insert Size Metrics
# -----------------------------------------------
gatk/gatk CollectAlignmentSummaryMetrics R=${ref} I=${aligned_reads}/HG008-N-D_sorted_dedup_bqsr_reads.bam  O=${aligned_reads}/HG008-N-D_alignment_metrics.txt
gatk/gatk CollectInsertSizeMetrics INPUT=${aligned_reads}/HG008-N-D_sorted_dedup_bqsr_reads.bam OUTPUT=${aligned_reads}/HG008-N-D_insert_size_metrics.txt HISTOGRAM_FILE=${aligned_reads}/HG008-N-D_insert_size_histogram.pdf

gatk CollectAlignmentSummaryMetrics R=${ref} I=${aligned_reads}/HG008-T_sorted_dedup_bqsr_reads.bam  O=${aligned_reads}/HG008-T_alignment_metrics.txt
gatk CollectInsertSizeMetrics INPUT=${aligned_reads}/HG008-T_sorted_dedup_bqsr_reads.bam OUTPUT=${aligned_reads}/HG008-T_insert_size_metrics.txt HISTOGRAM_FILE=${aligned_reads}/HG008-T_insert_size_histogram.pdf

# -----------------------
# Step 7: Mutect2 â€“ Somatic Variant Calling (https://gatk.broadinstitute.org/hc/en-us/articles/360035531132--How-to-Call-somatic-mutations-using-GATK4-Mutect2)
# -----------------------
gatk Mutect2 -R ${ref} \
    -I ${aligned_reads}/HG008-T_sorted_dedup_bqsr_reads.bam \
    -I ${aligned_reads}/HG008-N-D_sorted_dedup_bqsr_reads.bam \
    -tumor HG008-T \
    -normal HG008-N-D \
    --germline-resource ${mutect2_supporting_files}/af-only-gnomad.hg38.vcf.gz \
    --panel-of-normals ${mutect2_supporting_files}/1000g_pon.hg38.vcf.gz \
    -O ${results}/HG008_somatic_variants_mutect2.vcf.gz \
    --f1r2-tar-gz ${results}/HG008_f1r2.tar.gz

# ----------------------------------------------
# STEP 8: Estimate cross-sample contamination
# ----------------------------------------------

# GetPileupSummaries
# Summarizes counts of reads that support reference, alternate, and other alleles for given sites. Results are used with CalculateContamination.
# Intervals: wget https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/exome_calling_regions.v1.1.interval_list

# tumor
gatk GetPileupSummaries \
    --java-options '-Xmx50G' --tmp-dir ${project_dir}/tmp/ \
    -I ${aligned_reads}/HG008-T_sorted_dedup_bqsr_reads.bam \
    -V ${mutect2_supporting_files}/af-only-gnomad.hg38.vcf.gz \
    -L ${mutect2_supporting_files}/exome_calling_regions.v1.1.interval_list \
    -O ${results}/HG008_T_getpileupsummaries.table

# normal
gatk GetPileupSummaries \
    --java-options '-Xmx50G' --tmp-dir ${project_dir}/tmp/ \
    -I ${aligned_reads}/HG008-N-D_sorted_dedup_bqsr_reads.bam  \
    -V ${mutect2_supporting_files}/af-only-gnomad.hg38.vcf.gz \
    -L ${mutect2_supporting_files}/exome_calling_regions.v1.1.interval_list \
    -O ${results}/HG008-N-D_getpileupsummaries.table

# Calculate contamination
gatk CalculateContamination \
    -I ${results}/HG008_T_getpileupsummaries.table \
    -matched ${results}/HG008-N-D_getpileupsummaries.table \
    -O ${results}/HG008_pair_calculatecontamination.table 

# ----------------------------------------------
# STEP 9: Estimate read orientation artifacts
# ----------------------------------------------

# read orientation
gatk LearnReadOrientationModel \
    -I ${results}/HG008_f1r2.tar.gz \
    -O ${results}/read-orientation-model.tar.gz

# ----------------------------------------------
# STEP 10: Filter Variants Called By Mutect2
# ----------------------------------------------
gatk FilterMutectCalls \
        -V ${results}/HG008_somatic_variants_mutect2.vcf.gz \
        -R ${ref} \
        --contamination-table ${results}/HG008_pair_calculatecontamination.table \
        --ob-priors ${results}/read-orientation-model.tar.gz \
        -O ${results}/HG008_somatic_variants_filtered_mutect2.vcf

# ----------------------------------------------
# STEP 11: Annotate Variants - Funcotator
# ----------------------------------------------
gatk Funcotator \
    --variant ${results}/HG008_somatic_variants_filtered_mutect2.vcf \
    --reference ${ref} \
    --ref-version hg38 \
    --data-sources-path /home/prithasaha/funcotator_dataSources.v1.7.20200521S 
    --output ${results}/HG008_somatic_variants_functotated.vcf \
    --output-file-format VCF





